@page "/"
@using BlazorControls.Components
@rendermode InteractiveServer

<h3>Dashboard</h3>

<div class="chart-wrapper">
    <div class="home-checkboxlist">

        <CheckBoxList Items="@AllTaskLabels"
                      KeySelector="label => label"
                      LabelSelector="label => label"
                      CheckedSelector="label => SelectedTaskMap[label]"
                      OnChanged="OnTaskChanged" />

    </div>

    <!-- Donut Chart -->
    <div class="chart-container">
        <DonutChart Title="Tasks (Donut)"
                    InnerTitle="@CurrentTaskLabels.Count.ToString()"
                    IsDonut="true"
                    Thickness="40"
                    Data="@pieData"
                    IncludeLabels="@CurrentTaskLabels"
                    StatusColors="@TaskColors"
                    OnSliceClick="HandleSliceClick"
                    OnCenterClick="HandleCenterClick"
                    ShowLegend="true" />
    </div>

    <!-- Pie Chart -->
    <div class="chart-container">
        <DonutChart Title="Tasks (Piechart)"
                    InnerTitle="Tasks"
                    IsDonut="false"
                    Data="@pieData"
                    IncludeLabels="@CurrentTaskLabels"
                    StatusColors="@TaskColors"
                    OnSliceClick="HandleSliceClick"
                    ShowLegend="true" />

        <div class="filter-text">
            <strong>Filtered Tasks:</strong>
            @if (CurrentTaskLabels.Count > 0)
            {
                <span>@string.Join(", ", CurrentTaskLabels.OrderBy(m => m))</span>
            }
            else
            {
                <span>(none)</span>
            }
        </div>
    </div>

</div>

@code {
    private Dictionary<string, int> pieData = new()
    {
        ["Completed"] = 30,
        ["In Progress"] = 25,
        ["Blocked"] = 5,
        ["Not Started"] = 12,
        ["On Hold"] = 4,
        ["Under Review"] = 17,
        ["Pending Approval"] = 3,
        ["Cancelled"] = 2,
        ["Deferred"] = 6
    };

    private List<string> AllTaskLabels => pieData.Keys.Order().ToList();

    private Dictionary<string, bool> SelectedTaskMap = new();

    private List<string> CurrentTaskLabels =>
        SelectedTaskMap.Where(kvp => kvp.Value).Select(kvp => kvp.Key).ToList();

    private Task OnTaskChanged((string Key, bool IsChecked) change)
    {
        SelectedTaskMap[change.Key] = change.IsChecked;
        return Task.CompletedTask;
    }

    protected override void OnInitialized()
    {
        SelectedTaskMap = AllTaskLabels.ToDictionary(label => label, _ => true);

        // Example: hide two labels initially
        SelectedTaskMap["Completed"] = false;
        SelectedTaskMap["Blocked"] = false;
    }

    private void HandleSliceClick(ChartClickEventArgs e)
    {
        Console.WriteLine($"[Home] Slice clicked: {e.SliceLabel}");
    }

    private void HandleCenterClick(ChartClickEventArgs e)
    {
        Console.WriteLine("[Home] Center clicked");
    }

    private Dictionary<string, string> TaskColors = new()
    {
        ["Completed"] = "#4CAF50",
        ["In Progress"] = "#2196F3",
        ["Blocked"] = "#F44336",
        ["Not Started"] = "#9E9E9E",
        ["On Hold"] = "#FF9800",
        ["Under Review"] = "#9C27B0",
        ["Pending Approval"] = "#FFC107",
        ["Cancelled"] = "#000000",
        ["Deferred"] = "#795548"
    };
}
